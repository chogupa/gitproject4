<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>ã‚²ãƒ¼ãƒ ç”»é¢</title>
	<link rel="stylesheet" href="../../static/style.css" th:href="@{/style.css}">
	<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=DotGothic16&display=swap"
		rel="stylesheet">
</head>

<body class="game-body">
	
	<p>ğŸ’£ï¼š4å€‹</p>
	<table class="game-board">
		<tr th:each="row : ${#numbers.sequence(0,4)}">
			<td th:each="col : ${#numbers.sequence(0,4)}" th:with="cell=${dbList[row * 5 + col]}"
				th:attr="data-id=${cell.id}, data-flag=${cell.flag}, data-bomb=${cell.bomb}, data-count=${cell.count},data-comment=${cell.comment}"
				th:text="' '">
			</td>
		</tr>
	</table>

	<form method="post" action="#" th:action="@{confirmreset}">
			<input type="submit" value="ãƒªã‚»ãƒƒãƒˆ" class="ResetButton">
		</form>

	<script>
		
			
		//å…¨ã¦ã®ãƒã‚¹ã‚’å–å¾—
		const allTds = document.querySelectorAll('td[data-id]');

		// å®‰å…¨ãƒã‚¹ã®ç·æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
		let safeCount = 0;
		allTds.forEach(td => {

			const bomb = td.getAttribute('data-bomb');
			if (bomb !== '1') { // '1'ä»¥å¤–ãŒå®‰å…¨ãƒã‚¹
				safeCount++;
			}
		});

		let revealedCount = 0; // é–‹ã„ãŸå®‰å…¨ãƒã‚¹ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

		const revealCell = (td, bomb, count) => {
			
			const longPressDuration = 300; // 300ãƒŸãƒªç§’
			let pressTimer = null;

			allTds.forEach(td => {
				const cellId = td.getAttribute('data-id');

				// é•·æŠ¼ã—ã®å‡¦ç†
				td.addEventListener('mousedown', e => {
					if (e.button !== 0) return; // å·¦ã‚¯ãƒªãƒƒã‚¯ä»¥å¤–ã¯ç„¡è¦–ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ã¯æ—¢ã«æ——å‡¦ç†ãŒã‚ã‚‹ï¼‰
					pressTimer = setTimeout(() => {
						window.location.href = `/edit/${cellId}`;
					}, longPressDuration);
				});

				td.addEventListener('mouseup', () => {
					clearTimeout(pressTimer);
				});

				td.addEventListener('mouseleave', () => {
					clearTimeout(pressTimer);
				});


			});

			//ã‚‚ã—trueãªã‚‰(1åº¦é–‹ã‹ã‚Œã¦ã„ã‚‹ãªã‚‰)ãã®ã¾ã¾ãƒªã‚¿ãƒ¼ãƒ³
			if (td.dataset.revealed === 'true' || td.dataset.flagged === 'true') return;
			td.dataset.revealed = 'true';  //é–‹ã‹ã‚Œã¦ãªã‘ã‚‰ã°trueã‚’ä»£å…¥
			const cellId = td.getAttribute('data-id');

			<!--			ç©ºã‘ãŸãƒã‚¹ç›®ã®æƒ…å ±ã‚’ä¿æŒ-->
			let revealedCells = JSON.parse(localStorage.getItem('revealedCells')) || [];
			if (!revealedCells.includes(cellId)) {
				revealedCells.push(cellId);
				localStorage.setItem('revealedCells', JSON.stringify(revealedCells));
			}

			// åœ°é›·åˆ¤å®š
			if (bomb === '1') {
				td.textContent = 'ğŸ’£';
				td.style.backgroundColor = '#ff4d4d ';
				window.location.href = '/gameover';
			}
			// å‘¨ã‚Šã«åœ°é›·ãŒã‚ã‚‹å®‰å…¨ãƒã‚¹
			else {
				td.textContent = count === '0' ? '0' : count;
				revealedCount++;
				td.classList.add('revealed-safe');
			}

			// ã™ã¹ã¦ã®å®‰å…¨ãƒã‚¹ã‚’é–‹ã„ãŸã‹ãƒã‚§ãƒƒã‚¯
			if (revealedCount === safeCount) {
				window.location.href = '/gameclear';
			}
		};
		//ãƒ‡ãƒ¼ã‚¿ï¼ˆå‘¨ã‚Šã«ã‚ã‚‹åœ°é›·ã®æ•°ã€ã¾ãŸã¯åœ°é›·ï¼‰ã®èª­ã¿è¾¼ã¿
		allTds.forEach(td => {
			const count = td.getAttribute('data-count');
			const bomb = td.getAttribute('data-bomb');   


			// å·¦ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã
			td.addEventListener('click', () => revealCell(td, bomb, count));



			// å³ã‚¯ãƒªãƒƒã‚¯ã®æ“ä½œ
			function toggleFlag(td) {
				const cellId = td.getAttribute('data-id');
				let flaggedCells = JSON.parse(localStorage.getItem('flaggedCells')) || [];

				if (td.dataset.flagged === 'true') {
					// æ——ã‚’å¤–ã™
					td.dataset.flagged = 'false';
					td.classList.remove('flagged');
					td.textContent = '';
					flaggedCells = flaggedCells.filter(id => id !== cellId);
				} else {
					// æ——ã‚’ç«‹ã¦ã‚‹
					td.dataset.flagged = 'true';
					td.classList.add('flagged');
					td.textContent = 'ğŸš©';
					if (!flaggedCells.includes(cellId)) {
						flaggedCells.push(cellId);
					}


				}
                //localStrageã«ç©ºã„ãŸãƒã‚¹ã€æ——ã‚’ç«‹ã¦ãŸãƒã‚¹ã®æƒ…å ±ã‚’ä¿å­˜
				localStorage.setItem('flaggedCells', JSON.stringify(flaggedCells));
			}

		
			// ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã‚’è¡Œã†ã‹åˆ¤å®š
			if (document.referrer.includes('/index') || document.referrer.includes('confirmreset')) {
				localStorage.removeItem('flaggedCells');
				localStorage.removeItem('revealedCells');
			}
			//å³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–
			td.addEventListener('contextmenu', e => {
				e.preventDefault();
				if (td.dataset.revealed === 'true') return;

				toggleFlag(td);

				
			});

		});
		//  ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ——ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
		window.addEventListener('DOMContentLoaded', () => {
			const flaggedCells = JSON.parse(localStorage.getItem('flaggedCells')) || [];
			flaggedCells.forEach(id => {
				const td = document.querySelector(`td[data-id="${id}"]`);
				if (td) {
					td.dataset.flagged = 'true';
					td.classList.add('flagged');
					td.textContent = 'ğŸš©';
				}
			});
			//ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒã‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
			const revealedCells = JSON.parse(localStorage.getItem('revealedCells')) || [];
			revealedCount = revealedCells.length; // é–‹ã„ãŸãƒã‚¹æ•°ã‚’åˆæœŸåŒ–
			revealedCells.forEach(id => {
				const td = document.querySelector(`td[data-id="${id}"]`);
				if (td && td.dataset.revealed !== 'true') {
					td.dataset.revealed = 'true';
					const bomb = td.getAttribute('data-bomb');
					const count = td.getAttribute('data-count');
					if (bomb === '1') {
						td.textContent = 'ğŸ’£';
						td.style.backgroundColor = '#ff4d4d ';
					} else {
						td.textContent = count === '0' ? '0' : count;
						td.classList.add('revealed-safe');
					}
				}
			});
		});


		// å¹ãå‡ºã—ã‚’ä½œæˆ
		const tooltip = document.createElement('div');
		tooltip.className = 'tooltip-popup';
		document.body.appendChild(tooltip);

		allTds.forEach(td => {
			td.addEventListener('mouseenter', (e) => {
				const comment = td.getAttribute('data-comment');
				if (comment && comment.trim() !== '') {
					tooltip.textContent = comment;
					tooltip.style.display = 'block';

					const rect = td.getBoundingClientRect();
					tooltip.style.left = `${rect.left + window.scrollX}px`;
					tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 8}px`; // ä¸Šã«è¡¨ç¤º
				}
			});

			td.addEventListener('mouseleave', () => {
				tooltip.style.display = 'none';
			});
		});
	</script>

</body>

</html>